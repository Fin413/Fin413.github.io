<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Online Tuner</title>
    <style>
        :root {
            --compass-radius: 200px;
        }

        body {
            margin: 0;
        }

        canvas {
            display: block;
        }

        #tunerContainer {
            position: relative;
        }

        #displayContainer {
            display: flex;
            position: absolute;
            justify-content: space-between;
            align-items: center;
            text-align: center;

            width: 190px;
            left: 50%;
            top: 43%;

            transform: translate(-50%, -50%);
        }

        .adjacentNote {
            font-size: 0.75em;
        }

        #octaveDisp {
            position: absolute;
            font-size: 0.6em;
            bottom: 0;
            left: 50%;
        }

        #needle {
            position: absolute;
            width: 250px;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            transition: transform 0.5s, filter 500ms;

            -webkit-filter: drop-shadow(-5px -5px 5px #222222);
            filter: drop-shadow(-5px -5px 5px #222222);
            /* transition: filter 500ms; */
        }

        /* letter wheel styling */

        .letterWheel {
            width: 50px;
            height: 50px;
            overflow: hidden;
            position: absolute;
            /* left: 45%; */
        }

        .letterWheel::after {
            content: "";
            position: absolute;
            inset: 0;
            box-shadow: inset 0 0 8px black;
        }

        .rotationContainer {
            position: absolute;
            left: 50%;
            top: -25px;
            transform: translateX(-50%);
            transition: transform 1s;
        }

        .wheelImg {
            width: 350px;
            display: block;
        }

        .mainNote {
            left: 50%;
            top: 14%;
            transform: translate(-50%, -50%);

            /* border-image: linear-gradient(to right, #c5d1d1 0%, #7a7b83 100%) 1;
            border-width: 4px;
            border-style: solid; */
        }

        .sharpNote {
            right: 50%;
            top: 50%;
            transform: translate(calc(var(--compass-radius) - 15px), -50%) rotate(90deg);

            /* border-image: linear-gradient(to top, #c5d1d1 0%, #7a7b83 100%) 1;
            border-width: 4px;
            border-style: solid; */
        }

        .flatNote {
            left: 50%;
            top: 50%;
            transform: translate(calc(-1 * (var(--compass-radius) - 15px)), -50%) rotate(-90deg);

            /* border-image: linear-gradient(to bottom, #c5d1d1 0%, #7a7b83 100%) 1;
            border-width: 4px;
            border-style: solid; */
        }


        /* number scroll styling */

        .numberScroll {
            width: 1.1em;
            height: 1.6em;
            overflow: hidden;
            position: absolute;
            box-shadow: inset 0 0 5px black;
            /* box-shadow: 
                inset 0px 11px 5px -10px #000,
                inset 0px -11px 5px -10px #000; */
            background-color: #E2C8A5;
/* 
            border-image: linear-gradient(to right, #c5d1d1 0%, #7a7b83 100%) 1;
            border-width: 2px;
            border-style: solid; */
        }

        .numbersContainer {
            position: absolute;
            left: 50%;
            top: 3px;
            transform: translateX(-50%);

            transition: top 0.75s;
            transition-timing-function: cubic-bezier(0.64, 0.57, 0.67, 1.20);

            text-align: center;
            font-weight: bold;
        }

        .numbersContainer > p {
            height: 50px;
            margin: 0;
        }

        .octaveDisplay {
            left: 50%;
            top: 18%;
            transform: translateX(35px);
        }

        .detuneDisplay {
            width: 1.8em;
            position: relative;
        }

        .centsContainer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 135px;
            position: absolute;

            bottom: 50px;
            left: 50%;
            transform: translate(-50%, 0);
        }

        .accidentalText {
            width: 60px;
            position: relative;
        }

        .needleCentre {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background-color: greenyellow;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);

            transition: opacity 1s;
            opacity: 0;
        }

        .compassRim {
            width: calc(var(--compass-radius) * 2 + 20px);
            height: calc(var(--compass-radius) * 2 + 20px);
            /* background-color: red; */
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);

            background-image: url('./tickMarks(3).png');
            background-size: 90%;
            background-position: center;
            background-repeat: no-repeat;

            
            /* border: double 1em transparent;
            border-radius: 50%;
            background-size: 90%;
            background-position: center;
            background-image: url('./tickMarks.png'), 
                                linear-gradient(to right, rgb(188, 188, 188), rgb(108, 108, 108));
            background-origin: border-box;
            background-clip: content-box, border-box; */
        }

        #start {
            padding: 5px 10px;
        }
    </style>
</head>
<body>
    <div id="tunerContainer">
        <div class="compassRim"></div>
        
        <img id="needle" src="https://png.pngtree.com/png-vector/20230603/ourmid/pngtree-compass-needle-red-white-vector-png-image_7118194.png">
        <div class="needleCentre"></div>

        <div class="letterWheel mainNote">
            <div class="rotationContainer">
                <img src="noteRing.png" class="wheelImg">
            </div>
        </div>

        <div class="octaveDisplay numberScroll">
            <div class="numbersContainer">
                <p>9</p>
                <p>8</p>
                <p>7</p>
                <p>6</p>
                <p>5</p>
                <p>4</p>
                <p>3</p>
                <p>2</p>
                <p>1</p>
                <p>0</p>
            </div>
        </div>

        <div class="letterWheel flatNote border-black">
            <div class="rotationContainer border-black">
                <img src="noteRing.png" class="wheelImg">
            </div>
        </div>

        <div class="letterWheel sharpNote">
            <div class="rotationContainer">
                <img src="noteRing.png" class="wheelImg">
            </div>
        </div>

        <div class="centsContainer">
            <div class="detuneDisplay numberScroll">
                <div class="numbersContainer">
                </div>
            </div>
            <p>cents</p>
            <div class="accidentalText numberScroll">
                <div class="numbersContainer">
                    <p>sharp</p>
                    <p>flat</p>
                </div>
            </div>
        </div>

        <div class="compass">
        </div>


        <canvas></canvas>
    </div>

    <button id="start">Start Tuner</button>

    <script>
        setTimeout(() => {
            updateWheel(document.querySelector('.mainNote'), "A");
            updateNumberScroll(octaveDisplay, 4);
            updateNumberScroll(detuneDisplay, 45);
            updateWheel(document.querySelector('.flatNote'), "G#");
            updateWheel(document.querySelector('.sharpNote'), "A#");
        }, 500)

        var audioCtx;
        var analyser;
        
        var bufferLength;
        var floatTimeData;
        var byteTimeData = new Uint8Array(2048);
        var sinewaveOffset = 0;

        var needleAngle = 0;

        var noteWheelInfo = {
            mainNote: {
                currentNote: "A",
                angle: 0,
            },
            flatNote: {
                currentNote: "A",
                angle: 0,
            },
            sharpNote: {
                currentNote: "A",
                angle: 0,
            }
        };
        
        var previousNote;
        var currentNote = "A";
        var currentScrollNum = 9;

        const compassRadius = 200;
        const allNotes = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
        
        const numberScroll = document.querySelector('.numberScroll');

        const canvas = document.querySelector('canvas');
        const canvasCtx = canvas.getContext('2d');

        const noteDisplay = document.querySelector('.mainNote');
        const needle  = document.getElementById('needle');
        const flatDisplay = document.querySelector('.flatNote');
        const sharpDisplay = document.querySelector('.sharpNote');
        const accidentalText = document.querySelector('.accidentalText');

        const detuneDisplay = document.querySelector('.detuneDisplay');
        const octaveDisplay = document.querySelector('.octaveDisplay');
        for (let i = 50; i > -1; --i) {
            let p = document.createElement('p');
            p.innerText = i;
            if (i < 10) p.innerText = '0' + i;
            detuneDisplay.querySelector('.numbersContainer').appendChild(p);
        }

        const startBtn = document.getElementById('start');
        startBtn.addEventListener('click', (e) => {
            navigator.mediaDevices
                .getUserMedia({ audio: true })
                .then((stream) => {
                    audioCtx = new AudioContext(); // audio context must be created within user event

                    analyser = audioCtx.createAnalyser();
                    analyser.smoothingTimeConstant = 0.85;
                    analyser.fftSize = 2048; 

                    bufferLength = analyser.frequencyBinCount;
                    floatTimeData = new Float32Array(bufferLength);

                    const source = audioCtx.createMediaStreamSource(stream);
                    source.connect(analyser);
                    
                    loop();
                });
        });

        var dir = -1;
        var amp = 50;

        idleLoop();
        function idleLoop() {
            canvasCtx.clearRect(0, 0, canvas.width, canvas.height);

            // sine wave
            canvasCtx.beginPath();
            canvasCtx.lineWidth = 2;
            canvasCtx.strokeStyle = "rgb(0,0,0)";

            var x = 0;
            var y = 0;
            // amp = 50;
            var freq = 25;
            var points = [0, 0]
            
            while(x <= canvas.width){
                y = canvas.height / 2 + amp * Math.sin((x + sinewaveOffset) / freq);
                canvasCtx.lineTo(x, y);

                if(x == canvas.width / 2) points[0] = y;
                x++;
            }

            if(sinewaveOffset > 100000) sinewaveOffset = 0; // fix this shit
            sinewaveOffset += 1;
            amp += dir;
            if (amp == -50) dir = 1;
            else if (amp == 50) dir = -1;

            canvasCtx.stroke();

            // circle
            canvasCtx.translate(0.5, 0.5);
            canvasCtx.fillStyle = 'white';
            canvasCtx.beginPath();
            canvasCtx.arc(canvas.width / 2, canvas.height / 2, compassRadius, 0, 2 * Math.PI);
            canvasCtx.fill();
            canvasCtx.stroke();
            canvasCtx.translate(-0.5, -0.5);

            if (!audioCtx) requestAnimationFrame(idleLoop);
        }

        function loop() {
            analyser.getFloatTimeDomainData(floatTimeData);
            analyser.getByteTimeDomainData(byteTimeData);

            // pitch handling
            let note;
            let pitch = autoCorrelate(floatTimeData, audioCtx.sampleRate);
            if (pitch != -1) {
                note = getNoteInfo(pitch);


                // only change note if it is returned twice in a row

                if (previousNote == note.name) {

                    // main note and octave display
                    updateWheel(noteDisplay, note.name);
                    updateNumberScroll(octaveDisplay, note.octave);

                    // next notes displays
                    updateWheel(flatDisplay, note.flatNote);
                    updateWheel(sharpDisplay, note.sharpNote);

                    // cents off display
                    updateNumberScroll(detuneDisplay, Math.abs(note.centsOff));

                    // sharp/flat display
                    if(note.centsOff < 0) updateNumberScroll(accidentalText, 0);
                    else updateNumberScroll(accidentalText, 1);

                    // green in-tune indicator
                    if(Math.abs(note.centsOff) < 5) {
                        document.querySelector('.needleCentre').style.opacity = 1;
                    } else {
                        document.querySelector('.needleCentre').style.opacity = 0;
                    }

                    // needle
                    needleAngle = (note.centsOff / 50) * 90;
                    updateNeedleShadow(needleAngle);
                    needle.style.transform = `translate(-50%, -50%) rotate(${needleAngle}deg)`;

                    console.log(needleAngle)

                    // console.log(note.flatNote, note.name, note.sharpNote, note.octave, note.centsOff);
                } else {
                    previousNote = note.name;
                }
            }

            // waveform handling
            canvasCtx.clearRect(0, 0, canvas.width, canvas.height);

            canvasCtx.lineWidth = 1;
            canvasCtx.strokeStyle = 'black';
            canvasCtx.beginPath();

            var x = 0;
            var sliceWidth = canvas.width * 1.0 / bufferLength;
            for (var i = 0; i < bufferLength; i++) {
                var v = byteTimeData[i] / 128.0;
                var y = v * canvas.height / 2;

                if (i === 0) canvasCtx.moveTo(x, y);
                else canvasCtx.lineTo(x, y);

                x += sliceWidth;
            }

            canvasCtx.lineTo(canvas.width, canvas.height / 2);
            canvasCtx.stroke();

            // circle
            canvasCtx.translate(0.5, 0.5);
            canvasCtx.fillStyle = 'white';
            canvasCtx.beginPath();
            canvasCtx.arc(canvas.width / 2, canvas.height / 2, compassRadius, 0, 2 * Math.PI);
            canvasCtx.fill();
            canvasCtx.stroke();
            canvasCtx.translate(-0.5, -0.5);

            requestAnimationFrame(loop);
        }

        function autoCorrelate( buf, sampleRate ) {
            // github @cwilso
            // Implements the ACF2+ algorithm
            
            var SIZE = buf.length;
            var rms = 0;

            for (var i=0;i<SIZE;i++) {
                var val = buf[i];
                rms += val*val;
            }
            rms = Math.sqrt(rms/SIZE);
            if (rms<0.01) // not enough signal
                return -1;

            var r1=0, r2=SIZE-1, thres=0.2;
            for (var i=0; i<SIZE/2; i++)
                if (Math.abs(buf[i])<thres) { r1=i; break; }
            for (var i=1; i<SIZE/2; i++)
                if (Math.abs(buf[SIZE-i])<thres) { r2=SIZE-i; break; }

            buf = buf.slice(r1,r2);
            SIZE = buf.length;

            var c = new Array(SIZE).fill(0);
            for (var i=0; i<SIZE; i++)
                for (var j=0; j<SIZE-i; j++)
                    c[i] = c[i] + buf[j]*buf[j+i];

            var d=0; while (c[d]>c[d+1]) d++;
            var maxval=-1, maxpos=-1;
            for (var i=d; i<SIZE; i++) {
                if (c[i] > maxval) {
                    maxval = c[i];
                    maxpos = i;
                }
            }
            var T0 = maxpos;

            var x1=c[T0-1], x2=c[T0], x3=c[T0+1];
            a = (x1 + x3 - 2*x2)/2;
            b = (x3 - x1)/2;
            if (a) T0 = T0 - b/(2*a);

            return sampleRate/T0;
        }



        // -----=====< Helper Functions >=====----- \\


        window.addEventListener('resize', resizeCanvas);
        function resizeCanvas(){
            canvas.height = 450;
            canvas.width = document.body.clientWidth;
        }
        resizeCanvas();

        function getNoteInfo(frequency) {
            // 440 = A4, A4 is midi number 69
            let midiNum = Math.round(12 * Math.log2(frequency /  440)) + 69; 

            let name = allNotes[midiNum % 12]
            let octave = Math.trunc(midiNum / 12) - 1;

            let perfectPitch = 440 * Math.pow(2, (midiNum - 69) / 12);
            let centsOff = Math.floor(1200 * Math.log2(frequency / perfectPitch)); // 1200 = (12 notes * 100 cents)
            
            let flatNote = "B";
            if (name != "C") flatNote = allNotes[(midiNum % 12) - 1];

            let sharpNote = "C";
            if (name != "B") sharpNote = allNotes[(midiNum % 12) + 1];

            return {
                name: name, 
                octave: octave,
                centsOff: centsOff,
                flatNote: flatNote,
                sharpNote: sharpNote,
            };
        }

        function updateWheel(wheelEl, targetNote) {
            const rotationContainer = wheelEl.querySelector('.rotationContainer');

            let wheelName = wheelEl.classList[1];
            let wheelData = noteWheelInfo[wheelName];

            let currentIndex = allNotes.indexOf(wheelData.currentNote);
            let targetIndex = allNotes.indexOf(targetNote);

            let normal = currentIndex - targetIndex;
            let rightWrap = 12 - currentIndex + targetIndex;
            let leftWrap = currentIndex + (12 - targetIndex);

            let angle = normal * 30;

            if (rightWrap < Math.abs(normal)) angle = -rightWrap * 30;
            else if (leftWrap < Math.abs(normal)) angle = leftWrap * 30;

            wheelData.angle += angle;
            wheelData.currentNote = targetNote;

            rotationContainer.style.transform = `translateX(-50%) rotate(${wheelData.angle}deg)`;
        }

        function updateNumberScroll(numberEl, targetNum) {
            const topOffset = 3;
            const letterSpacing = 50;
            let maxNum = numberEl.querySelector('.numbersContainer').children.length - 1;

            let newOffset = -1 * (-topOffset + (maxNum - targetNum) * letterSpacing);
            numberEl.querySelector('.numbersContainer').style.top = `${newOffset}px`;
        }

        function updateNeedleShadow(angle) {
            // assuming shadow position top right
            //  0deg  = (-5, +5) (pointing up)
            //  90deg = (-5, -5) (pointing right)
            // -90deg = (+5, +5) (pointing left)

            const maxShadowLength = 5;

            let ratio = angle / 90;
            let horizontal = -maxShadowLength;
            let vertical = maxShadowLength;

            if(ratio < 0) vertical -= Math.abs(ratio) * (maxShadowLength * 2);
            else horizontal += Math.abs(ratio) * (maxShadowLength * 2);

            needle.style.filter = `drop-shadow(${horizontal}px ${vertical}px 5px #222222)`;
        }
    </script>
</body>
</html>
